---
import { useSanityClient } from '@sanity/astro'
import { SITE_DESCRIPTION, SITE_TITLE } from 'src/config/consts'
import Layout from 'src/layouts/Layout.astro'

export async function getBlogPosts() {
  const query = `*[_type == "post"]{mainImage{asset->{path,url}}, 'tags': tags[].tag->{title}, ...}`
  const posts = await useSanityClient().fetch<any[]>(query)
  return posts.map(({ title, slug, _createdAt, _updatedAt, body, mainImage }) => ({
    title,
    slug: slug.current,
    body,
    heroImage: mainImage?.asset?._ref,
    createdAt: _createdAt,
    updatedAt: _updatedAt,
  }))
}

const posts = await getBlogPosts()
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <section class="flex flex-col mx-auto p-2 text-blue-50">
    {
      posts.map(
        (post, idex) =>
          idex === 0 && <pre class="whitespace-normal primary-bg-color text-white">{JSON.stringify(post)}</pre>,
      )
    }
  </section>
</Layout>
